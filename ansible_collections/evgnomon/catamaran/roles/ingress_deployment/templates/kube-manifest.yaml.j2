# Comprehensive Kubernetes YAML for Podman Kube Play
# Generated by Ansible role: nginx_podman
# Run with: podman kube play {{ nginx_kube_manifest_dest }}

---
# =============================================================================
# ConfigMap - Store nginx configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ nginx_app_name }}-config
  labels:
    app: {{ nginx_app_name }}
data:
  nginx.conf: |
{{ lookup('template', 'nginx.conf.j2') | indent(4, first=true) }}
  index.html: |
{{ lookup('template', 'index.html.j2') | indent(4, first=true) }}

---
# =============================================================================
# Secret - Store sensitive data (base64 encoded)
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ nginx_app_name }}-secret
  labels:
    app: {{ nginx_app_name }}
type: Opaque
data:
  username: {{ nginx_secret_username | b64encode }}
  password: {{ nginx_secret_password | b64encode }}
stringData:
  api-key: "{{ nginx_secret_api_key }}"

---
# =============================================================================
# PersistentVolumeClaim - Request persistent storage
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ nginx_app_name }}-data-pvc
  labels:
    app: {{ nginx_app_name }}
spec:
  accessModes:
    - {{ nginx_pvc_access_mode }}
  resources:
    requests:
      storage: {{ nginx_pvc_storage_size }}

---
# =============================================================================
# Pod - Simple standalone nginx pod
# =============================================================================
apiVersion: v1
kind: Pod
metadata:
  name: {{ nginx_app_name }}-standalone-pod
  labels:
    app: {{ nginx_app_name }}
    component: standalone
spec:
  containers:
    - name: nginx
      image: {{ nginx_image }}
      ports:
        - containerPort: {{ nginx_container_port }}
          hostPort: {{ nginx_host_port }}
      volumeMounts:
        - name: config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: html-volume
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        - name: data-volume
          mountPath: /var/log/nginx
      env:
        - name: NGINX_USER
          valueFrom:
            secretKeyRef:
              name: {{ nginx_app_name }}-secret
              key: username
        - name: NGINX_PASS
          valueFrom:
            secretKeyRef:
              name: {{ nginx_app_name }}-secret
              key: password
      resources:
        limits:
          memory: "{{ nginx_memory_limit }}"
          cpu: "{{ nginx_cpu_limit }}"
        requests:
          memory: "{{ nginx_memory_request }}"
          cpu: "{{ nginx_cpu_request }}"
      livenessProbe:
        httpGet:
          path: {{ nginx_health_path }}
          port: {{ nginx_container_port }}
        initialDelaySeconds: {{ nginx_liveness_initial_delay }}
        periodSeconds: {{ nginx_liveness_period }}
      readinessProbe:
        httpGet:
          path: {{ nginx_health_path }}
          port: {{ nginx_container_port }}
        initialDelaySeconds: {{ nginx_readiness_initial_delay }}
        periodSeconds: {{ nginx_readiness_period }}
  volumes:
    - name: config-volume
      configMap:
        name: {{ nginx_app_name }}-config
    - name: html-volume
      configMap:
        name: {{ nginx_app_name }}-config
    - name: data-volume
      persistentVolumeClaim:
        claimName: {{ nginx_app_name }}-data-pvc
  restartPolicy: Always

---
# =============================================================================
# Deployment - Managed replica set of nginx pods
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ nginx_app_name }}-deployment
  labels:
    app: {{ nginx_app_name }}
    component: deployment
spec:
  replicas: {{ nginx_deployment_replicas }}
  selector:
    matchLabels:
      app: {{ nginx_app_name }}
      component: deployment
  template:
    metadata:
      labels:
        app: {{ nginx_app_name }}
        component: deployment
    spec:
      containers:
        - name: nginx
          image: {{ nginx_image }}
          ports:
            - containerPort: {{ nginx_container_port }}
          volumeMounts:
            - name: config-volume
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: html-volume
              mountPath: /usr/share/nginx/html/index.html
              subPath: index.html
          env:
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ nginx_app_name }}-secret
                  key: api-key
          resources:
            limits:
              memory: "{{ nginx_memory_limit }}"
              cpu: "{{ nginx_cpu_limit }}"
            requests:
              memory: "{{ nginx_memory_request }}"
              cpu: "{{ nginx_cpu_request }}"
      volumes:
        - name: config-volume
          configMap:
            name: {{ nginx_app_name }}-config
        - name: html-volume
          configMap:
            name: {{ nginx_app_name }}-config

---
# =============================================================================
# DaemonSet - Runs nginx on every node
# =============================================================================
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ nginx_app_name }}-daemonset
  labels:
    app: {{ nginx_app_name }}
    component: daemonset
spec:
  selector:
    matchLabels:
      app: {{ nginx_app_name }}
      component: daemonset
  template:
    metadata:
      labels:
        app: {{ nginx_app_name }}
        component: daemonset
    spec:
      containers:
        - name: nginx-monitor
          image: {{ nginx_image }}
          ports:
            - containerPort: {{ nginx_container_port }}
          volumeMounts:
            - name: config-volume
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          resources:
            limits:
              memory: "{{ nginx_daemonset_memory_limit }}"
              cpu: "{{ nginx_daemonset_cpu_limit }}"
      volumes:
        - name: config-volume
          configMap:
            name: {{ nginx_app_name }}-config
      tolerations:
        - operator: Exists

---
# =============================================================================
# Job - One-time task (tests nginx connectivity)
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ nginx_app_name }}-connectivity-test
  labels:
    app: {{ nginx_app_name }}
    component: job
spec:
  ttlSecondsAfterFinished: {{ nginx_job_ttl_seconds }}
  backoffLimit: {{ nginx_job_backoff_limit }}
  template:
    metadata:
      labels:
        app: {{ nginx_app_name }}
        component: job
    spec:
      containers:
        - name: curl-test
          image: {{ curl_image }}
          command:
            - /bin/sh
            - -c
            - |
{{ lookup('template', 'job-test-script.sh.j2') | indent(14, first=true) }}
          env:
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ nginx_app_name }}-secret
                  key: api-key
      restartPolicy: Never
